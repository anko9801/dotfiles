#!/usr/bin/env bash
# YADM configuration and bootstrap setup

set -e

echo "======================================"
echo "        YADM Configuration            "
echo "======================================"
echo

# Function to set a config value
set_config() {
    local key="$1"
    local value="$2"
    yadm config "$key" "$value"
    echo "âœ“ Set $key = $value"
}

# Check and set class
current_class=$(yadm config local.class 2>/dev/null || echo "")
if [[ -z "$current_class" ]]; then
    echo "No class is set. Please choose one:"
else
    echo "Current class: $current_class"
    read -p "Change? (y/N): " -n 1 -r
    echo
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo
    else
        current_class=""
    fi
fi

if [[ -z "$current_class" ]]; then
    echo "1) personal - Personal machine"
    echo "2) work     - Work machine"
    echo "3) server   - Server/headless machine"
    read -p "Select [1-3]: " -n 1 -r
    echo
    case "$REPLY" in
        1) set_config local.class personal ;;
        2) set_config local.class work ;;
        3) set_config local.class server ;;
        *) echo "Invalid selection"; exit 1 ;;
    esac
fi

# Git configuration
echo
echo "Git Configuration:"
echo "-----------------"
current_email=$(yadm config user.email 2>/dev/null || echo "")
current_name=$(yadm config user.name 2>/dev/null || echo "")

if [[ -z "$current_email" ]]; then
    read -p "Git email: " email
    [[ -n "$email" ]] && set_config user.email "$email"
else
    echo "Email: $current_email"
fi

if [[ -z "$current_name" ]]; then
    read -p "Git name: " name
    [[ -n "$name" ]] && set_config user.name "$name"
else
    echo "Name: $current_name"
fi

# Optional configurations
echo
echo "Optional Settings:"
echo "-----------------"

# Auto-commit
auto_commit=$(yadm config yadm.auto-commit 2>/dev/null || echo "false")
echo "Auto-commit: $auto_commit"
read -p "Enable auto-commit? (y/N): " -n 1 -r
echo
if [[ $REPLY =~ ^[Yy]$ ]]; then
    set_config yadm.auto-commit true
    set_config yadm.auto-commit-msg "Auto update from $(hostname)"
fi

# Bootstrap
echo
read -p "Run bootstrap now? (Y/n): " -n 1 -r
echo

if [[ ! $REPLY =~ ^[Nn]$ ]]; then
    echo
    echo "Generating configuration files..."
    yadm alt
    
    echo
    echo "Starting bootstrap..."
    exec yadm bootstrap
else
    echo
    echo "Configuration complete!"
    echo "Run 'yadm bootstrap' when ready."
fi