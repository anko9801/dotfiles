#!/usr/bin/env bash
# Common functions for bootstrap scripts

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

# Logging
info() { echo -e "${BLUE}==>${NC} $1"; }
success() { echo -e "${GREEN}✓${NC} $1"; }
error() { echo -e "${RED}✗${NC} $1" >&2; }
warning() { echo -e "${YELLOW}!${NC} $1"; }

# Check if command exists
command_exists() {
    command -v "$1" &>/dev/null
}

# Get yadm class
get_yadm_class() {
    yadm config local.class 2>/dev/null || echo "personal"
}

# Install mise
install_mise() {
    if ! command_exists mise; then
        info "Installing mise..."
        curl https://mise.run | sh
        
        # Add to current session
        export PATH="$HOME/.local/bin:$PATH"
        
        success "mise installed"
    fi
    
    # Setup mise tools
    if command_exists mise; then
        eval "$(mise activate bash)" || true
        mise install node@lts python@latest || true
        mise use -g node@lts python@latest || true
    fi
}

# Setup development environment
setup_development_environment() {
    info "Setting up development environment..."
    
    # Create necessary directories
    mkdir -p "$HOME/.config" "$HOME/.local/bin" "$HOME/.local/share" "$HOME/.cache"
    
    # Setup git
    if command_exists git-secrets; then
        mkdir -p ~/.config/git/templates/git-secrets
        git secrets --install ~/.config/git/templates/git-secrets >/dev/null 2>&1 || true
        git config --global init.templateDir ~/.config/git/templates/git-secrets
        git secrets --register-aws >/dev/null 2>&1 || true
    fi
    
    # Install npm packages
    if command_exists npm; then
        npm install -g aicommits || true
    fi
    
    # Install GitHub Copilot CLI
    if command_exists gh; then
        gh extension install github/gh-copilot 2>/dev/null || true
    fi
}

# Setup Zsh
setup_zsh() {
    info "Setting up Zsh..."
    
    # Install zinit
    if [[ ! -d "$HOME/.local/share/zsh/zinit" ]]; then
        mkdir -p ~/.local/share/zsh
        git clone https://github.com/zdharma-continuum/zinit.git ~/.local/share/zsh/zinit/bin
    fi
    
    # Set as default shell if not already
    if [[ "$SHELL" != *"zsh"* ]] && command_exists zsh; then
        info "To set zsh as default shell, run: chsh -s $(which zsh)"
    fi
}

# Setup system ZDOTDIR
setup_system_zdotdir() {
    if [[ ! -f "/etc/zsh/zshenv" ]] || ! grep -q "ZDOTDIR" "/etc/zsh/zshenv" 2>/dev/null; then
        info "To remove .zshenv from home, set ZDOTDIR system-wide:"
        echo "  echo 'export ZDOTDIR=\"\$HOME/.config/zsh\"' | sudo tee -a /etc/zsh/zshenv"
    fi
}

# Post install
post_install() {
    success "Bootstrap completed!"
    
    local class=$(get_yadm_class)
    echo
    echo "Configuration: class=$class, OS=$(uname -s)"
    echo
    echo "Next steps:"
    echo "1. Restart your shell: exec zsh"
    echo "2. Run: yadm alt"
    echo
}