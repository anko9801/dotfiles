#!/usr/bin/env bash

# Common functions for bootstrap scripts
# このファイルは各OS別のbootstrapからsourceされます

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[0;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info() { echo -e "${BLUE}[INFO]${NC} $1"; }
success() { echo -e "${GREEN}[SUCCESS]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; }
warning() { echo -e "${YELLOW}[WARNING]${NC} $1"; }

# Check if command exists
command_exists() {
    command -v "$1" &> /dev/null
}

# Install mise
install_mise() {
    if ! command_exists mise; then
        info "Installing mise..."
        curl https://mise.run | sh
        success "mise installed"
    else
        info "mise already installed"
    fi
}

# Setup mise tools
setup_mise_tools() {
    if command_exists mise; then
        info "Setting up mise tools..."
        
        # Activate mise
        eval "$(mise activate zsh)"
        
        # Install common tools
        mise install node@lts
        mise install python@latest
        mise install ruby@latest
        mise install go@latest
        mise install rust@latest
        
        # Set as global
        mise use -g node@lts
        mise use -g python@latest
        mise use -g ruby@latest
        mise use -g go@latest
        mise use -g rust@latest
        
        success "mise tools configured"
    fi
}

# Setup npm global packages
setup_npm_packages() {
    # npm packages are now managed by mise
    info "npm packages are managed by mise - see .config/mise/config.toml"
}

# Setup system-wide ZDOTDIR (requires sudo)
setup_system_zdotdir() {
    info "Setting up system-wide ZDOTDIR configuration..."
    
    local system_zshenv="/etc/zsh/zshenv"
    local zdotdir_line='export ZDOTDIR="$HOME/.config/zsh"'
    
    # Check if already configured
    if [[ -f "$system_zshenv" ]] && grep -q "ZDOTDIR" "$system_zshenv"; then
        info "ZDOTDIR already configured in $system_zshenv"
        return 0
    fi
    
    # Ask for confirmation
    warning "This requires sudo access to modify $system_zshenv"
    echo "Do you want to add ZDOTDIR to system configuration? (y/N)"
    read -r response
    
    if [[ "$response" =~ ^[Yy]$ ]]; then
        # Create /etc/zsh directory if it doesn't exist
        [[ ! -d "/etc/zsh" ]] && sudo mkdir -p /etc/zsh
        
        # Add ZDOTDIR configuration
        echo "$zdotdir_line" | sudo tee -a "$system_zshenv" > /dev/null
        
        # Remove .zshenv from home if it exists
        [[ -f "$HOME/.zshenv" ]] && rm -f "$HOME/.zshenv"
        
        success "System-wide ZDOTDIR configured (no .zshenv needed!)"
    else
        info "Skipping system configuration. Using .zshenv instead."
    fi
}

# Setup Vim
setup_vim() {
    # Create vim directories
    mkdir -p "$HOME/.config/vim"
    mkdir -p "$HOME/.local/share/vim/dein"
    
    if [[ ! -d "$HOME/.local/share/vim/dein" ]]; then
        info "Installing dein.vim..."
        curl https://raw.githubusercontent.com/Shougo/dein.vim/master/bin/installer.sh > /tmp/installer.sh
        sh /tmp/installer.sh ~/.local/share/vim/dein
        rm /tmp/installer.sh
        success "dein.vim installed"
    fi
}

# Setup Zsh
setup_zsh() {
    # Create zsh directories
    mkdir -p "$HOME/.config/zsh"
    mkdir -p "$HOME/.local/share/zsh"
    
    # Install zinit (to XDG location)
    if [[ ! -d "$HOME/.local/share/zsh/zinit" ]]; then
        info "Installing zinit..."
        mkdir -p ~/.local/share/zsh
        git clone https://github.com/zdharma-continuum/zinit.git ~/.local/share/zsh/zinit/bin
        success "zinit installed"
    fi
    
    # Set as default shell if requested
    if [[ "${YADM_SHELL:-}" == "zsh" ]] && command_exists zsh; then
        info "Setting zsh as default shell..."
        chsh -s $(which zsh)
    fi
}

# Clone repositories
clone_repos() {
    local repos_dir="$HOME/repos"
    mkdir -p "$repos_dir"
    
    # Add any common repositories to clone here
}

# Create XDG directories
create_xdg_dirs() {
    info "Creating XDG directories..."
    mkdir -p "$HOME/.config"
    mkdir -p "$HOME/.local/bin"
    mkdir -p "$HOME/.local/share"
    mkdir -p "$HOME/.local/state"
    mkdir -p "$HOME/.cache"
}

# Post install message
# Setup git hooks
setup_git_hooks() {
    info "Setting up git hooks..."
    
    # Link pre-commit hook for yadm repository
    if [[ -d "$HOME/.local/share/yadm/repo.git" ]]; then
        ln -sf "$HOME/.config/git/hooks/pre-commit" "$HOME/.local/share/yadm/repo.git/hooks/pre-commit"
        success "Git hooks configured for yadm repository"
    else
        warning "yadm repository not found, skipping git hooks"
    fi
}

post_install() {
    success "Bootstrap completed!"
    echo
    echo "Next steps:"
    echo "1. Restart your shell or run: source ~/.zshenv && source $ZDOTDIR/.zshrc"
    echo "2. Check yadm status: yadm status"
    echo
    info "パパッと楽に理想の環境を手に入れました！"
}