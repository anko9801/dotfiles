#!/usr/bin/env bash
# Pre-bootstrap configuration

set -e

echo "======================================"
echo "     YADM Bootstrap Configuration     "
echo "======================================"
echo

# Check current class
current_class=$(yadm config local.class 2>/dev/null || echo "not set")

# Set or change class
if [[ "$current_class" == "not set" ]]; then
    echo "No yadm class is set. Please choose one:"
else
    echo "Current class: $current_class"
    echo
    read -p "Change class? (y/N): " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 0
fi

echo "1) personal - Personal machine"
echo "2) work     - Work machine"
echo "3) server   - Server/headless machine"
echo

read -p "Select class [1-3]: " -n 1 -r
echo

case "$REPLY" in
    1) yadm config local.class personal ;;
    2) yadm config local.class work ;;
    3) yadm config local.class server ;;
    *) echo "Invalid selection"; exit 1 ;;
esac

# Show what will be installed
echo
echo "Bootstrap will install:"
echo "----------------------"
class=$(yadm config local.class)

case "$class" in
    work)
        echo "- Standard dev tools + Work tools (AWS, Docker, K8s)"
        ;;
    personal)
        echo "- Standard dev tools + Media tools (ffmpeg, etc.)"
        ;;
    server)
        echo "- Minimal tools for server environment"
        ;;
esac

# Generate alternates
echo
echo "Generating configuration files..."
yadm alt

echo
read -p "Start bootstrap? (Y/n): " -n 1 -r
echo

if [[ $REPLY =~ ^[Nn]$ ]]; then
    echo "Bootstrap cancelled"
    exit 0
fi

echo "Starting bootstrap..."
exec yadm bootstrap