#!/usr/bin/env bash
# Git pre-commit hook - prevent committing secrets

set -e

# Run git-secrets if available
if command -v git-secrets &>/dev/null; then
    git secrets --pre_commit_hook -- "$@" || exit 1
fi

# Define secret patterns to check
declare -a patterns=(
    # Authentication
    'api[_-]?key.*[:=][[:space:]]*["\047]?[a-zA-Z0-9_-]{20,}'
    'token.*[:=][[:space:]]*["\047]?[a-zA-Z0-9_-]{20,}'
    'secret.*[:=][[:space:]]*["\047]?[a-zA-Z0-9_-]{20,}'
    'AKIA[0-9A-Z]{16}'
    'aws[_-]?(access[_-]?key[_-]?id|secret[_-]?access[_-]?key)'
    'oauth[_-]?token'
    'bearer[[:space:]]+[a-zA-Z0-9_-]{20,}'
    
    # Private Keys
    '-----BEGIN[[:space:]]+(RSA|DSA|EC|OPENSSH|PGP)[[:space:]]+PRIVATE[[:space:]]+KEY'
    
    # Connection strings
    '(mysql|postgresql|mongodb|redis)://[^:]+:[^@]+@'
    
    # Environment files
    '\.env\.(local|production|staging)'
)

# Get staged files once
staged_files=$(git diff --cached --name-only -z)

# Check for secrets in staged files
if [[ -n "$staged_files" ]]; then
    for pattern in "${patterns[@]}"; do
        if echo "$staged_files" | xargs -0 grep -qE "$pattern" 2>/dev/null; then
            echo "Error: Potential secret detected (pattern: $pattern)"
            echo "Remove the secret or add to .gitignore"
            exit 1
        fi
    done
fi

exit 0