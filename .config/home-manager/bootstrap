#!/usr/bin/env bash
set -euo pipefail

# Dotfiles Bootstrap - Pure Nix Home Manager
# All configuration is managed declaratively via Nix

# Colors
readonly RED='\033[0;31m' GREEN='\033[0;32m' BLUE='\033[0;34m' NC='\033[0m'
info() { printf "${BLUE}==>${NC} %s\n" "$1"; }
success() { printf "${GREEN}==>${NC} %s\n" "$1"; }
error() { printf "${RED}==>${NC} %s\n" "$1" >&2; }

# Platform detection
detect_platform() {
    case "$(uname -s)" in
        Darwin*) echo "darwin" ;;
        Linux*)
            grep -q Microsoft /proc/version 2>/dev/null && echo "wsl" || echo "linux"
            ;;
        *) echo "unknown" ;;
    esac
}

# Install Nix
install_nix() {
    if command -v nix &>/dev/null; then
        info "Nix already installed"
        return 0
    fi

    info "Installing Nix..."
    sh <(curl -L https://nixos.org/nix/install) --daemon

    # Source nix
    [ -f /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh ] && \
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
}

# Enable flakes
enable_flakes() {
    local nix_conf="$HOME/.config/nix/nix.conf"
    if grep -q "experimental-features.*flakes" "$nix_conf" 2>/dev/null; then
        return 0
    fi

    info "Enabling Nix flakes..."
    mkdir -p "$(dirname "$nix_conf")"
    echo 'experimental-features = nix-command flakes' >> "$nix_conf"
}

# Run Home Manager
run_home_manager() {
    local platform="$1"
    local hm_dir="$HOME/.config/home-manager"

    # Determine configuration name
    local config_name
    case "$platform" in
        darwin) config_name="anko-mac" ;;
        wsl)    config_name="anko@wsl" ;;
        linux)  config_name="anko@linux" ;;
        *)      error "Unsupported platform: $platform"; return 1 ;;
    esac

    info "Activating Home Manager ($config_name)..."

    if [[ "$platform" == "darwin" ]]; then
        # Use nix-darwin for macOS
        nix run nix-darwin -- switch --flake "$hm_dir#$config_name"
    else
        # Use home-manager for Linux/WSL
        nix run home-manager -- switch --flake "$hm_dir#$config_name" -b backup
    fi
}

# WSL setup
setup_wsl() {
    local wsl_conf="$HOME/.config/wsl/wsl.conf"
    if [[ -f "$wsl_conf" ]] && [[ ! -f /etc/wsl.conf ]]; then
        info "Installing wsl.conf (requires sudo)..."
        sudo cp "$wsl_conf" /etc/wsl.conf
        success "wsl.conf installed - restart WSL to apply"
    fi
}

# Main
main() {
    local platform
    platform=$(detect_platform)

    info "Bootstrap starting (platform: $platform)"

    install_nix
    enable_flakes
    run_home_manager "$platform"

    # Platform-specific post-setup
    [[ "$platform" == "wsl" ]] && setup_wsl

    success "Bootstrap complete!"
    echo ""
    echo "Next steps:"
    echo "  1. Restart your shell: exec \$SHELL"
    echo "  2. Update config: home-manager switch --flake ~/.config/home-manager"
}

main "$@"
