#!/bin/sh
# Polyglot setup script: works in bash/sh AND PowerShell
#
# Usage:
#   curl -fsSL https://raw.githubusercontent.com/anko9801/dotfiles/master/setup | sh   (Unix)
#   iwr https://raw.githubusercontent.com/anko9801/dotfiles/master/setup | iex         (Windows)
#
# Flags (Unix):
#   --git-name NAME     Git user.name
#   --git-email EMAIL   Git user.email
#   --git-key KEY       SSH public key for signing
#   --editor EDITOR     Preferred editor (nvim, code, hx)
#   --non-interactive   Skip all prompts

echo --% > /dev/null ; : ' | out-null
<#'

# ============================================================================
# UNIX (bash/sh)
# ============================================================================
set -eu

REPO="https://github.com/anko9801/dotfiles.git"
DOTFILES="$HOME/dotfiles"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info()    { printf "${BLUE}[INFO]${NC} %s\n" "$1"; }
success() { printf "${GREEN}[OK]${NC} %s\n" "$1"; }
warn()    { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
error()   { printf "${RED}[ERROR]${NC} %s\n" "$1"; exit 1; }

confirm() {
    if [ "${NON_INTERACTIVE:-}" = "1" ]; then return 0; fi
    printf "%s [Y/n] " "$1"
    read -r reply
    case "$reply" in
        [Nn]*) return 1 ;;
        *) return 0 ;;
    esac
}

prompt() {
    if [ "${NON_INTERACTIVE:-}" = "1" ]; then
        echo "$2"
        return
    fi
    printf "%s [%s]: " "$1" "$2"
    read -r reply
    if [ -z "$reply" ]; then
        echo "$2"
    else
        echo "$reply"
    fi
}

# Parse flags
GIT_NAME=""
GIT_EMAIL=""
GIT_KEY=""
EDITOR_PREF=""
NON_INTERACTIVE=""

while [ $# -gt 0 ]; do
    case "$1" in
        --git-name)       GIT_NAME="$2"; shift 2 ;;
        --git-email)      GIT_EMAIL="$2"; shift 2 ;;
        --git-key)        GIT_KEY="$2"; shift 2 ;;
        --editor)         EDITOR_PREF="$2"; shift 2 ;;
        --non-interactive) NON_INTERACTIVE="1"; shift ;;
        *) shift ;;
    esac
done

echo ""
echo "  ╔═══════════════════════════════════════╗"
echo "  ║           Dotfiles Setup              ║"
echo "  ╚═══════════════════════════════════════╝"
echo ""

# Detect OS
case "$(uname -s)" in
    Darwin) OS="darwin" ;;
    Linux)
        if grep -qi microsoft /proc/version 2>/dev/null; then
            OS="wsl"
        else
            OS="linux"
        fi
        ;;
    *) error "Unsupported OS. Run this on macOS, Linux, or WSL." ;;
esac

# Detect architecture
ARCH="$(uname -m)"
case "$ARCH" in
    arm64|aarch64) ARCH_NAME="ARM64" ;;
    x86_64)        ARCH_NAME="x86_64" ;;
    *)             ARCH_NAME="$ARCH" ;;
esac

info "Detected: $OS ($ARCH_NAME)"
echo ""

if ! confirm "Proceed with installation?"; then
    echo "Aborted."
    exit 0
fi
echo ""

# Step 1: Install Nix
if ! command -v nix >/dev/null 2>&1; then
    info "[1/4] Installing Nix..."
    if confirm "Install Nix via Determinate Systems installer?"; then
        curl -fsSL https://install.determinate.systems/nix | sh -s -- install
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        success "Nix installed"
    else
        warn "Skipping Nix installation"
    fi
else
    success "[1/4] Nix already installed ($(nix --version))"
fi

# Step 2: Clone dotfiles
info "[2/4] Setting up dotfiles..."
if [ ! -d "$DOTFILES" ]; then
    git clone "$REPO" "$DOTFILES"
    success "Cloned to $DOTFILES"
else
    git -C "$DOTFILES" pull --rebase 2>/dev/null || true
    success "Updated $DOTFILES"
fi

# Step 3: Configure user
info "[3/4] Configuring user..."
echo ""
echo "  Configure your personal settings."
echo "  Press Enter to keep default values."
echo ""

GIT_NAME="${GIT_NAME:-$(prompt "Git name" "$(whoami)")}"
GIT_EMAIL="${GIT_EMAIL:-$(prompt "Git email" "$GIT_NAME@users.noreply.github.com")}"
GIT_KEY="${GIT_KEY:-$(prompt "SSH public key (for signing)" "")}"
EDITOR_PREF="${EDITOR_PREF:-$(prompt "Editor (nvim, code, hx)" "nvim")}"

mkdir -p "$DOTFILES/users"
cat > "$DOTFILES/users/$USER.nix" << EOF
# User-specific configuration
# Regenerate with: ./setup --non-interactive --git-name NAME --git-email EMAIL
{
  editor = "$EDITOR_PREF";
  theme = "catppuccin";

  git = {
    name = "$GIT_NAME";
    email = "$GIT_EMAIL";
    sshKey = "$GIT_KEY";
  };

  sshHosts = { };
}
EOF
success "Generated users/$USER.nix"

# Step 4: Apply config
info "[4/4] Applying configuration..."
if confirm "Apply configuration for $OS?"; then
    cd "$DOTFILES"
    case "$OS" in
        darwin)
            if ! command -v darwin-rebuild >/dev/null 2>&1; then
                nix run nix-darwin -- switch --flake ".#mac"
            else
                sudo darwin-rebuild switch --flake ".#mac"
            fi
            ;;
        wsl)   nix run home-manager -- switch --impure --flake ".#wsl" ;;
        linux) nix run home-manager -- switch --impure --flake ".#linux-desktop" ;;
    esac
    success "Configuration applied"
else
    warn "Skipping configuration"
fi

echo ""
success "Done!"
echo ""
echo "  Next steps:"
echo "    exec zsh                 # Reload shell"
if [ "$OS" = "wsl" ]; then
echo "    nix run .#setup-windows  # Deploy Windows configs"
fi
echo ""
exit 0
#>

# ============================================================================
# WINDOWS (PowerShell)
# ============================================================================
$ErrorActionPreference = "Stop"

Write-Host @"

  ╔═══════════════════════════════════════╗
  ║       Dotfiles Setup (Windows)        ║
  ╚═══════════════════════════════════════╝

"@ -ForegroundColor Cyan

# Install packages via winget
Write-Host "Installing packages..." -ForegroundColor Yellow
$packagesUrl = "https://raw.githubusercontent.com/anko9801/dotfiles/master/system/windows/winget-packages.json"
$packagesFile = "$env:TEMP\winget-packages.json"
Invoke-WebRequest -Uri $packagesUrl -OutFile $packagesFile
winget import -i $packagesFile --accept-package-agreements --accept-source-agreements --ignore-unavailable 2>$null
Remove-Item $packagesFile -ErrorAction SilentlyContinue
Write-Host "  OK" -ForegroundColor Green

Write-Host ""
Write-Host "Done!" -ForegroundColor Green
