#!/bin/sh
# Polyglot script: works in bash/sh AND PowerShell
# Usage: curl -fsSL URL/setup | sh    (Unix)
#        iwr URL/setup | iex          (Windows)
#
# Flags (Unix):
#   --user NAME         System username
#   --git-name NAME     Git user.name
#   --git-email EMAIL   Git user.email
#   --git-key KEY       SSH public key for signing
#   --non-interactive   Skip all prompts

echo --% > /dev/null ; : ' | out-null
<#'

# ============================================================================
# UNIX (bash/sh)
# ============================================================================
set -eu

REPO="https://github.com/anko9801/dotfiles.git"
DOTFILES="$HOME/dotfiles"

# Colors (ANSI)
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

info()    { printf "${BLUE}[INFO]${NC} %s\n" "$1"; }
success() { printf "${GREEN}[OK]${NC} %s\n" "$1"; }
warn()    { printf "${YELLOW}[WARN]${NC} %s\n" "$1"; }
error()   { printf "${RED}[ERROR]${NC} %s\n" "$1"; exit 1; }

confirm() {
    if [ "${NON_INTERACTIVE:-}" = "1" ]; then return 0; fi
    printf "%s [Y/n] " "$1"
    read -r reply
    case "$reply" in
        [Nn]*) return 1 ;;
        *) return 0 ;;
    esac
}

prompt() {
    if [ "${NON_INTERACTIVE:-}" = "1" ]; then
        echo "$2"
        return
    fi
    printf "%s [%s]: " "$1" "$2"
    read -r reply
    if [ -z "$reply" ]; then
        echo "$2"
    else
        echo "$reply"
    fi
}

# Parse flags
USER_NAME=""
GIT_NAME=""
GIT_EMAIL=""
GIT_KEY=""
NON_INTERACTIVE=""

while [ $# -gt 0 ]; do
    case "$1" in
        --user)           USER_NAME="$2"; shift 2 ;;
        --git-name)       GIT_NAME="$2"; shift 2 ;;
        --git-email)      GIT_EMAIL="$2"; shift 2 ;;
        --git-key)        GIT_KEY="$2"; shift 2 ;;
        --non-interactive) NON_INTERACTIVE="1"; shift ;;
        *) shift ;;
    esac
done

echo ""
echo "  ╔═══════════════════════════════════════╗"
echo "  ║         Dotfiles Setup (Unix)         ║"
echo "  ╚═══════════════════════════════════════╝"
echo ""

# Detect OS
case "$(uname -s)" in
    Darwin) OS="darwin" ;;
    Linux)
        if grep -qi microsoft /proc/version 2>/dev/null; then
            OS="wsl"
        else
            OS="linux"
        fi
        ;;
    *) error "Unsupported OS" ;;
esac

# Detect architecture
ARCH="$(uname -m)"
case "$ARCH" in
    arm64|aarch64) ARCH_NAME="ARM64 (Apple Silicon)" ;;
    x86_64)        ARCH_NAME="x86_64 (Intel)" ;;
    *)             ARCH_NAME="$ARCH" ;;
esac

info "Detected: $OS ($ARCH_NAME)"
echo ""

# Confirm before proceeding
if ! confirm "Proceed with installation?"; then
    echo "Aborted."
    exit 0
fi
echo ""

# Step 1: Install Nix
if ! command -v nix >/dev/null 2>&1; then
    info "[1/4] Installing Nix..."
    if confirm "Install Nix via Determinate Systems installer?"; then
        curl -fsSL https://install.determinate.systems/nix | sh -s -- install
        . /nix/var/nix/profiles/default/etc/profile.d/nix-daemon.sh
        success "Nix installed"
    else
        warn "Skipping Nix installation"
    fi
else
    success "[1/4] Nix already installed ($(nix --version))"
fi

# Step 2: Clone dotfiles
info "[2/4] Setting up dotfiles..."
if [ ! -d "$DOTFILES" ]; then
    git clone "$REPO" "$DOTFILES"
    success "Cloned dotfiles to $DOTFILES"
else
    git -C "$DOTFILES" pull --rebase
    success "Updated dotfiles"
fi

# Step 3: Configure user
info "[3/4] Configuring user..."
echo ""
echo "  Configure your personal settings."
echo "  Press Enter to keep default values."
echo ""

# Get current user as default
DEFAULT_USER="$(whoami)"
DEFAULT_WINDOWS_USER="$DEFAULT_USER"

# Prompt for values (or use flags)
USER_NAME="${USER_NAME:-$(prompt "Username" "$DEFAULT_USER")}"
WINDOWS_USER="${WINDOWS_USER:-$(prompt "Windows username (for WSL)" "$DEFAULT_WINDOWS_USER")}"
GIT_NAME="${GIT_NAME:-$(prompt "Git name" "$USER_NAME")}"
GIT_EMAIL="${GIT_EMAIL:-$(prompt "Git email" "$GIT_NAME@users.noreply.github.com")}"
GIT_KEY="${GIT_KEY:-$(prompt "SSH public key (for git signing, leave empty to skip)" "")}"

# Generate user.nix
cat > "$DOTFILES/user.nix" << EOF
# User-specific configuration
# Generated by setup script
{
  username = "$USER_NAME";
  windowsUsername = "$WINDOWS_USER";
  git = {
    name = "$GIT_NAME";
    email = "$GIT_EMAIL";
    sshKey = "$GIT_KEY";
  };
  sshHosts = { };
}
EOF
success "Generated user.nix"

# Step 4: Apply config
info "[4/4] Applying configuration..."
if confirm "Apply Nix configuration for $OS?"; then
    cd "$DOTFILES"
    case "$OS" in
        darwin)
            if ! command -v darwin-rebuild >/dev/null 2>&1; then
                nix run nix-darwin -- switch --flake ".#${USER_NAME}-mac"
            else
                sudo darwin-rebuild switch --flake ".#${USER_NAME}-mac"
            fi
            ;;
        wsl)   nix run home-manager -- switch --flake ".#${USER_NAME}@wsl" ;;
        linux) nix run home-manager -- switch --flake ".#${USER_NAME}@linux" ;;
    esac
    success "Configuration applied"
else
    warn "Skipping configuration"
fi

echo ""
success "Done! Run: exec zsh"
exit 0
#>

# ============================================================================
# WINDOWS (PowerShell)
# ============================================================================
$ErrorActionPreference = "Stop"
$dotfiles = "$env:USERPROFILE\dotfiles"
$repo = "https://github.com/anko9801/dotfiles.git"

Write-Host @"

  ╔═══════════════════════════════════════╗
  ║       Dotfiles Setup (Windows)        ║
  ╚═══════════════════════════════════════╝

"@ -ForegroundColor Cyan

# Check admin
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "Please run as Administrator!" -ForegroundColor Red
    exit 1
}

# winget
if (-not (Get-Command winget -ErrorAction SilentlyContinue)) {
    Write-Host "[1/4] Installing winget..." -ForegroundColor Yellow
    Invoke-WebRequest -Uri https://aka.ms/getwinget -OutFile winget.msixbundle
    Add-AppxPackage winget.msixbundle
    Remove-Item winget.msixbundle
} else {
    Write-Host "[1/4] winget OK" -ForegroundColor Green
}

# Git + clone
if (-not (Get-Command git -ErrorAction SilentlyContinue)) {
    winget install -e --id Git.Git --accept-package-agreements --accept-source-agreements
    $env:PATH += ";C:\Program Files\Git\cmd"
}

Write-Host "[2/4] Dotfiles..." -ForegroundColor Yellow
if (-not (Test-Path $dotfiles)) {
    git clone $repo $dotfiles
} else {
    Push-Location $dotfiles; git pull --rebase; Pop-Location
}

# Packages
Write-Host "[3/4] Packages..." -ForegroundColor Yellow
$json = "$dotfiles\windows\winget-packages.json"
if (Test-Path $json) {
    winget import -i $json --accept-package-agreements --accept-source-agreements --ignore-unavailable
}

# Git config
Write-Host "[4/5] Git config..." -ForegroundColor Yellow
git config --global core.autocrlf input
git config --global init.defaultBranch main

# WSL config
Write-Host "[5/5] WSL config..." -ForegroundColor Yellow
$wslConf = "$dotfiles\windows\wsl.conf"
if (Test-Path $wslConf) {
    $wslPath = $wslConf -replace '\\','/' -replace 'C:','/mnt/c'
    $diff = wsl -u root sh -c "diff -q '$wslPath' /etc/wsl.conf 2>/dev/null"
    if ($LASTEXITCODE -ne 0) {
        wsl -u root sh -c "[ -f /etc/wsl.conf ] && cp /etc/wsl.conf /etc/wsl.conf.bak"
        wsl -u root cp "$wslPath" /etc/wsl.conf
        Write-Host "  wsl.conf installed (backup: /etc/wsl.conf.bak)" -ForegroundColor Green
    } else {
        Write-Host "  wsl.conf unchanged" -ForegroundColor Green
    }
}

Write-Host "`n  Done! Run 'wsl --shutdown' to apply wsl.conf" -ForegroundColor Cyan
